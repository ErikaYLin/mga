# Hello, world!
#
# This is an example function named 'hello'
# which prints 'Hello, world!'.
#
# You can learn more about package authoring with RStudio at:
#
#   http://r-pkgs.had.co.nz/
#
# Some useful keyboard shortcuts for package authoring:
#
#   Install Package:           'Ctrl + Shift + B'
#   Check Package:             'Ctrl + Shift + E'
#   Test Package:              'Ctrl + Shift + T'


# mga(fastq.Fs, fastq.Rs, filtFs, filtRs, refFasta, metadata = NULL, tree.args = list(k = 4, inv = 0.2, model = "GTR", rearrangement = "stochastic"), network.args = list(type = "taxa", distance = "jaccard", max.dist = 0.45, keep.isolates = TRUE), seed = 100, multithread = TRUE)


TEST <- function(x, # phyloseq object
                 plant_pathogens = NULL # .csv object listing taxa to search for
                 ) {

  # Convert phyloseq tax_table to a data frame
  pathogen <- phyloseq::tax_table(ps.species)
  pathogen <- as.data.frame(pathogen)

  # Add genus to species name in Species column
  spec.names <- pathogen$Species
  pathogen$Species <- paste(pathogen$Genus, pathogen$Species, sep = " ")

  # Add column to indicate possible pathogenicity (yes = 1, no = 0)
  pathogen$pathogenic = 0
  pathogen$pathogenic_taxon = NA

  # Search for pathogens in taxonomy table
  for (j in 1:nrow(plant_pathogens)) {
    # Search in Family
    if ("Family" %in% plant_pathogens$Taxon[j]){
      for (i in 1:nrow(pathogen)) {
        if (plant_pathogens$Pathogen[j] %in% pathogen$Family[i]){
          pathogen$pathogenic[i] = 1
          pathogen$pathogenic_taxon[i] = plant_pathogens$Pathogen[j]
        }}
      # Search in Genus
    } else if ("Genus" %in% plant_pathogens$Taxon[j]){
      for (i in 1:nrow(pathogen)) {
        if (plant_pathogens$Pathogen[j] %in% pathogen$Genus[i]){
          pathogen$pathogenic[i] = 1
          if (is.na(pathogen$pathogenic_taxon[i])){
            pathogen$pathogenic_taxon[i] = plant_pathogens$Pathogen[j]
          }}}
      # search in Species
    } else if ("Species" %in% plant_pathogens$Taxon[j]){
      for (i in 1:nrow(pathogen)) {
        if (plant_pathogens$Pathogen[j] %in% pathogen$Species[i]){
          pathogen$pathogenic[i] = 1
          if (is.na(pathogen$pathogenic_taxon[i])){
            pathogen$pathogenic_taxon[i] = plant_pathogens$Pathogen[j]
          }}}
    } else {
      pathogen$pathogenic[i] = 0
      pathogen$pathogenic_taxon[i] = NA}
  }

  # Remove genus from species names
  pathogen$Species <- spec.names

  # Update the tax_table
  tax = phyloseq::tax_table(as.matrix(pathogen))
  phyloseq::tax_table(ps.species) <- tax

  # Extract pathogens only
  pathogen.only <- pathogen[pathogen$pathogenic == 1,]
  path.names <- row.names(pathogen.only)

  # Filter pathogens from ASV table
  pathogen.ps <- phyloseq::prune_taxa(path.names, ps.species)

  # Return the filtered phyloseq object
  return(pathogen.ps)
}
